---
title: "missForestPredict - convergence criteria and error monitoring"
author: "Elena Albu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{missForestPredict - convergence criteria and error monitoring}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

## What is this document?

This document explains in detail the convergence criteria and error monitoring.

For basic usage of the *missForestPredict* package read the *Using the missForestPredict package* vignette.

## Convergence criteria

At each iteration the out-of-bag (OOB) error is calculated for each variable separately. To obtain a global error the OOB errors for all variables a weighted average is used, that can be controlled by the *OOB_weights* parameter. By default all variables weight equally in the convergence criteria. 

The normalized mean square error (NMSE) is used for both continuous and categorical variables. For continuous variables, it is equivalent to $1 - R^2$. For categorical variables, it is equivalent to $1 - BSS$ (Brier Skill Score).

**Continuous variables**:

$NMSE = \frac{\sum_{i=1}^{N}(x_i - \hat{x_i})^2}{\sum_{i=1}^{N} (x_i - \bar{x})^2} = 1 - R^2$, $i = 1, 2, ... N$

$\bar{x}$ = the mean value of variable x

$\hat{x_i}$ = prediction (imputation) for observation i 

$N$ = number of observations

**Categorical variables (including ordinal factors)**:

$NMSE = \frac{BS}{BSref} = 1 - BSS$

$BS =\frac{1}{N}\sum_{j=1}^{R}\sum_{i=1}^{N}(p_{ij} - x_{ij})^2$, $i = 1, 2, ... N$, $j = 1, 2, ... R$

$BSref =\frac{1}{N}\sum_{j=1}^{R}\sum_{i=1}^{N}(p_{j} - x_{ij})^2=1-\sum_{j=1}^{R}p_j^2$

$p_{ij}$ = prediction (probability) for observation i and class j

$p_{j}$ = proportion of the event in class j

$N$ = number of observations

$R$ = number of classes

The Brier Score ($BS$) is calculated as the sum of squared distances between the predictions (as probabilities) and the true values (0 or 1) for each class. The reference Brier Score ($BSref$) is calculated as the Brier Score of a predictor that predicts the proportion of the event in each class [@brier1950verification].

## Imputation error monitoring

At each iteration, the MSE (mean squared error) and NMSE (normalized mean squared error) are saved and reported for each variable if *verbose = TRUE*. 

Post imputation, the error can be checked using the *evaluate_imputation_error* function. 

# Examples

## Data used for demonstration

**Iris data** The iris dataset contains in R base contains 4 continuous variables and one categorical variable with three categories for N = 150 flowers.

**Diamonds data** The diamonds dataset from ggplot2 R package contains seven continuous variables and three categorical variables for N = 53940 diamonds

## Inspect convergence errors

The MSE and NMSE errors are returned at the end of the imputation as part of the return object.

```{r}
library(missForestPredict)

data(iris)
set.seed(2022)
iris_mis <- produce_NA(iris, proportion = 0.5)

set.seed(2022)
missForest_object <- missForestPredict::missForest(iris_mis, verbose = TRUE)

print(missForest_object$err_MSE)

print(missForest_object$err_NMSE)

```

These can be plotted in a graph if visual inspection seems easier to understand. We will plot the errors using *ggplot2* package.

```{r fig.width = 7}
library(dplyr)
library(tidyr)
library(ggplot2)

col_names <- colnames(missForest_object$err_NMSE)

missForest_object$err_NMSE %>% 
  mutate(iteration = row_number()) %>% 
  pivot_longer(cols = all_of(col_names),
               values_to = "NMSE") %>% 
  ggplot(aes(iteration, NMSE, col = name)) +
  geom_point() +
  geom_line()

```


## Use weighted average in convergence

By default, all variables weight equally in calculating the OOB NMSE used in the convergence criteria. There can be situations when this in not the optimal choice. The weights for each variable can be adjusted via the *OOB_weights* parameter. In the following example we will create different proportion of missing values for each variable and adjust the weights to be proportional with the missingness proportion in the training set.

We will create missing values only on the last two variables (Petal.Width and Species) and first run the imputation with the default setting.

```{r fig.width = 7}
library(missForestPredict)
library(dplyr)
library(tidyr)
library(ggplot2)

data(iris)

proportion_missing <- c(0, 0, 0, 0.3, 0.3)

set.seed(2022)
iris_mis <- produce_NA(iris, proportion = proportion_missing)

set.seed(2022)
missForest_object <- missForestPredict::missForest(iris_mis, verbose = TRUE)

# plot convergence
col_names <- colnames(missForest_object$err_NMSE)

missForest_object$err_NMSE %>% 
  mutate(iteration = row_number()) %>% 
  pivot_longer(cols = all_of(col_names),
               values_to = "NMSE") %>% 
  ggplot(aes(iteration, NMSE, col = name)) +
  geom_point() +
  geom_line()

```

We will further adapt the weights to be proportional to the missingness rate in the training set. Keep in mind that missForestPredict builds models for all variables in the dataset, regardless of the missingness rate. Models will be built also for variables that are complete and these will weight equally by default in the convergence criteria. If these are expected to be complete also in future data (test set), but you choose to include them in the imputation scheme (as predictors for other variables), it might be optimal to give them weight zero in the convergence criteria. When doing so, imputation models will still be built and stored for these variables; if unexpectedly missing values will occur in your test set, these will be imputed using these learned models.

TODO: maybe it is a more sensible choice to adapt the weights by default to be proportional to the missingness in the training set? I will run some tests on it.

```{r fig.width = 7}

set.seed(2022)
missForest_object <- missForestPredict::missForest(iris_mis, verbose = TRUE, OOB_weights = proportion_missing)

# plot convergence
col_names <- colnames(missForest_object$err_NMSE)

missForest_object$err_NMSE %>% 
  mutate(iteration = row_number()) %>% 
  pivot_longer(cols = all_of(col_names),
               values_to = "NMSE") %>% 
  ggplot(aes(iteration, NMSE, col = name)) +
  geom_point() +
  geom_line()

```


## Assess imputation error when the true values are known

Post imputation, the error can be checked using the *evaluate_imputation_error* function. This can be done, of course, only when the true values (passed via *xtrue*) are known. The errors are calculated as differences from the true values.

As Species is a categorical variable and it is imputed with one of the classes of the variable (setosa, versicolor or virginica) and not with probabilities, only the MER (missclassification error rate) can be calculated post imputation.

By default, *evaluate_imputation_error* returns the MSE and NMSE using only the missing values, while the OOB error in the convergence criteria is calculated using only the non-missing values.

```{r}
evaluate_imputation_error(missForest_object$ximp, iris_mis, iris)

```

# References
